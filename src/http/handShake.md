## TCP三次握手和四次挥手

### 三次握手

建立一个TCP连接时，需要客户端和服务端总共发送3个包

主要作用就是为了确认双方的接收能力和发送能力是否正常，指定自己的初始化序列号为后面的可靠性传送做准备

#### 过程
第一次握手： 客户端给服务端发送一个SYN报文，并指明客户端的初始化序列号ISN(c)，此时客户端处于SYN_SENT状态

第二次握手：服务端收到客户端的SYN报文后，会以自己的SYN报文作为应答，为了确认客户端的SYN，将客户端的ISN+1作为ACK的值，此时服务器处于SYN_RCVD的状态

第三次握手：客户端收到SYN报文后，会发送一个ACK报文，值为服务器的ISN+1，此时客户端处于ESTABLISHED状态，服务器收到ACK报文后，也处于ESTABLISHED状态，此时双方建立起了连接

#### 每次握手的作用

第一次握手：客户端发送网络包，服务端收到了
这样服务端就能得出结论：客户端的发送能力，服务端的接收能力是正常的

第二次握手：服务端发包，客户端收到了
这样客户端就能得出结论：服务端的接受能力，发送能力，客户端的接收能力，发送能力是正常的。不过此时服务器并不能确认客户端的接收能力是否正常

第三次握手：客户端发包，服务端收到了
这样服务端就能得出结论：客户端的接收，发送能力正常，服务器自己的发送，接收能力也正常

通过三次握手，就能确定双方的接收和发送能力正常，之后就可以正常通信了

#### 为什么不是两次握手
1. 如果是两次握手，发送端可以确定自己发送的信息服务端能收到，也能确定对方发的包自己能收到，但是接收端智能确定对方发的包自己能收到，无法确定自己发的包对方能否收到

2. 两次握手的话，客户端可能因为网络阻塞等原因会发送多个请求报文，延时到达的请求又会与服务器建立连接，浪费很多服务器资源



### 四次挥手
TCP终止一个连接，需要经过四次挥手

#### 过程
第一次挥手： 客户端发送一个FIN报文，报文中指定一个序列号，此时客户端处于FIN_WAIT1状态，停止发送数据，等待服务端的确认

第二次挥手：服务端收到FIN之后，会发送ACK报文，且把客户端的序号值+1作为ACK报文的序列号值，表面已经接收到客户端的报文了，此时服务端处于CLOSE_WAIT状态

第三次挥手：如果服务端也想断开连接了，和客户端的第一次挥手一样，发送FIN报文，且指定一个序列号，此时服务端处于LAST_ACK状态

第四次挥手：客户端收到FIN之后，一样发送一个ACK报文作为应答，且把服务端的序列号值+1作为自己ACK报文的序列号值，此时客户端处于TIME_WAIT状态。需要过一阵子以确保服务端收到自己的ACK报文之后才会进入CLOSED状态。服务端收到ACK报文之后，就处于关闭连接了，处于CLOSED状态

#### 四次握手原因
服务端在收到客户端断开连接FIN报文后，并不会立即关闭，而是先发送一个ACK包先告诉客户端收到关闭连接的请求，只有当服务器的所有报文发送完毕之后，才会FIN报文断开连接，因此需要四次挥手

